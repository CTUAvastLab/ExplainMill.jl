<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Home · ExplainMill.jl</title><meta name="title" content="Home · ExplainMill.jl"/><meta property="og:title" content="Home · ExplainMill.jl"/><meta property="twitter:title" content="Home · ExplainMill.jl"/><meta name="description" content="Documentation for ExplainMill.jl."/><meta property="og:description" content="Documentation for ExplainMill.jl."/><meta property="twitter:description" content="Documentation for ExplainMill.jl."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script><link href="assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href><img class="docs-light-only" src="assets/logo.svg" alt="ExplainMill.jl logo"/><img class="docs-dark-only" src="assets/logo-dark.svg" alt="ExplainMill.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li class="is-active"><a class="tocitem" href>Home</a><ul class="internal"><li><a class="tocitem" href="#Installation"><span>Installation</span></a></li><li><a class="tocitem" href="#Getting-started"><span>Getting started</span></a></li><li class="toplevel"><a class="tocitem" href="#Breaking-change"><span>Breaking change</span></a></li><li class="toplevel"><a class="tocitem" href="#Discussion"><span>Discussion</span></a></li><li class="toplevel"><a class="tocitem" href="#ExplainMill.jl"><span>ExplainMill.jl</span></a></li><li><a class="tocitem" href="#Design-thoughts-on-logic-output"><span>Design thoughts on logic output</span></a></li></ul></li><li><span class="tocitem">Manual</span></li><li><span class="tocitem">Examples</span></li><li><span class="tocitem">Public API</span></li><li><a class="tocitem" href="references/">References</a></li><li><a class="tocitem" href="citation/">Citation</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Home</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Home</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CTUAvastLab/ExplainMill.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CTUAvastLab/ExplainMill.jl/blob/main/docs/src/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><img class="display-light-only" src="assets/logo.svg" alt="ExplainMill.jl logo" style="width: 40%;"/>
<img class="display-dark-only" src="assets/logo-dark.svg" alt="ExplainMill.jl logo" /style="width: 40%;"><h2 id="Installation"><a class="docs-heading-anchor" href="#Installation">Installation</a><a id="Installation-1"></a><a class="docs-heading-anchor-permalink" href="#Installation" title="Permalink"></a></h2><p>Run the following in REPL:</p><pre><code class="language-julia hljs">] add ExplainMill</code></pre><p>Julia v1.9 or later is required.</p><h2 id="Getting-started"><a class="docs-heading-anchor" href="#Getting-started">Getting started</a><a id="Getting-started-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-started" title="Permalink"></a></h2><ul><li><a href="references/#References">References</a>: related literature</li><li><a href="citation/#Citation">Citation</a>: preferred citation entries</li></ul><h1 id="Breaking-change"><a class="docs-heading-anchor" href="#Breaking-change">Breaking change</a><a id="Breaking-change-1"></a><a class="docs-heading-anchor-permalink" href="#Breaking-change" title="Permalink"></a></h1><p>As discussed below, I have removed the &quot;feature&quot; that dict with single child is ignored. </p><p>Below snippet fix cuckoo model and data trained on schema created by  JsonGrinder version 1.6.1 and reasonably below.</p><pre><code class="nohighlight hljs">function fixmodel(model)
	mm = @set model.ms.behavior.ms.enhanced.im = ProductModel((data = model[:behavior][:enhanced].im,), identity)
	mm = @set mm.ms.clipboard_changes.im = ProductModel((to = mm[:clipboard_changes].im,), identity)
	mm = @set mm.ms.signatures.im = ProductModel((name = mm[:signatures].im,), identity)
	mm = @set mm.ms.network.ms.domains.im = ProductModel((domain = mm[:network][:domains].im,), identity)
end

function fixdata(ds)
	dd = @set ds.data.behavior.data.enhanced.data = ProductNode((data = ds[:behavior][:enhanced].data,))
	dd = @set dd.data.clipboard_changes.data = ProductNode((to = dd[:clipboard_changes].data,))
	dd = @set dd.data.signatures.data = ProductNode((name = dd[:signatures].data,))
	dd = @set dd.data.network.data.domains.data = ProductNode((domain = dd[:network][:domains].data,))
end</code></pre><h1 id="Discussion"><a class="docs-heading-anchor" href="#Discussion">Discussion</a><a id="Discussion-1"></a><a class="docs-heading-anchor-permalink" href="#Discussion" title="Permalink"></a></h1><ul><li>Should we explicitly model missing in categorical variable as an n + 2 item?</li><li>Remove skipping of Dictionary in JsonGrinder and replace it with the IdentityModel()</li><li>ArrayModel in Mill should have a default for missing values and potentially ProductModel</li></ul><h1 id="ExplainMill.jl"><a class="docs-heading-anchor" href="#ExplainMill.jl">ExplainMill.jl</a><a id="ExplainMill.jl-1"></a><a class="docs-heading-anchor-permalink" href="#ExplainMill.jl" title="Permalink"></a></h1><p>This library provides an explanation of hierarchical multi-instance learning models using the method of Shapley values. This explanation method works by randomly perturbing &quot;features&quot; of the sample and observing the output of the classifier. The rationale behind the method is that if the feature is non-informative than the output of the classifier should be non-sensitive to its perturbation (and vice-versa). To support hierarchical models, we define several types of &quot;daf&quot; explainers.</p><ul><li><code>BagDaf</code> explains <code>Mill.BagNode</code> by removing instances</li><li><code>TreeDaf</code> is just a container and does not explain anything</li><li><code>ArrayDaf</code> explains dense matrices (<code>Mill.ArrayNode{Matrix}</code>) by removing</li></ul><p>features of all samples (instances). Explaining individual items in dense matrices can be easily added, but at the moment author (Pevnak) is more interested in the influence of a particular feature on the sample. Features are modified by setting them to zero. This method assumes that features are centred, which is considering the state of JsonGrinder unlikely. A better method would be to provide a set samples such that values of modified features are replaced with a random sample from the population.</p><ul><li><code>SparseArrayDaf</code> explains sparse matrix by zeroing individual items of the</li></ul><p>random matrix.</p><p>Let&#39;s demonstrate the usage. Assume that we want to explain sample <code>ds</code> with model <code>model</code> using 1000 random samples. After necessary setup the important line is <code>ExplainMill.explain(ds, model, n = 1000)</code> which does the explanation</p><pre><code class="nohighlight hljs">using Mill, ExplainMill, SparseArrays, Flux

an = ArrayNode(randn(2,5))
cn = ArrayNode(sprand(2,5, 0.5))
bn = BagNode(ProductNode((a = an, c = cn)), AlignedBags([1:2,3:5]))
tn = ProductNode((a = an[1:2], b = bn))
ds = BagNode(tn, AlignedBags([1:2]))
model = reflectinmodel(ds, d -&gt; Dense(d,2),
		d -&gt; SegmentedMean(d),
		b = Dict(&quot;&quot; =&gt; d -&gt; Dense(d,1)))

explained_ds = ExplainMill.explain(ds, model, n = 1000)</code></pre><p>The output of the model has to have dimension one. You might find convenient to use the following code to select specific output</p><pre><code class="nohighlight hljs">using Setfield
new_model = @set model.bm.m = Chain(model.bm, x -&gt; x[1,:])</code></pre><h3 id="Peaking-under-the-hood"><a class="docs-heading-anchor" href="#Peaking-under-the-hood">Peaking under the hood</a><a id="Peaking-under-the-hood-1"></a><a class="docs-heading-anchor-permalink" href="#Peaking-under-the-hood" title="Permalink"></a></h3><p>The explanation starts by creating a structure holding a shapley values for individual nodes. The structure resembles the Mill structure, but instead of data it holds <code>Duff.Daf</code> statistics. For a <code>ds</code>, the structure is created as</p><pre><code class="nohighlight hljs">daf = ExplainMill.Daf(ds)</code></pre><p>then, in the loop we repeatedlu create a sub-sample, calculate the shapley value, and update the stats</p><pre><code class="nohighlight hljs">using StatsBase, Duff
dss, mask = sample(daf, ds)
v = ExplainMill.scalar(model(dss))
Duff.update!(daf, mask, v)</code></pre><p>once the sufficient statistic is calculated, we extract the <code>mask</code> which will allow to prune the sample (by default everything all true which means no pruning.) Masks from individual level is returned together with daf statistics as a second argument, which allows to easily link daf statistics to cooresponding items in mask and in hierarchical mask. Using <code>CatViews</code> package further simplifies the construction, as</p><pre><code class="nohighlight hljs">using CatViews
mask, dafs = ExplainMill.masks_and_stats(daf)
catmask = CatView(tuple([d.m for d in dafs]...))
pvalue = CatView(tuple([Duff.UnequalVarianceTTest(d.d) for d in dafs]...))</code></pre><p><code>catmask</code> now behaves like a single array and similarly the p-values of a test where means of samples when the item / feaure is present. This means and if if we change item in <code>catmask</code>, the change is propagated to <code>mask</code> and <code>prune(ds, mask)</code> return the sample without the corresponding item. Note that since statistics is effectively zero as it has not been updated, pvalues are NaNs</p><p>Adding a support for new type of nodes (lists) is currently involved and it might undergo further changes. At the moment, it is simple to take it out of the explanation. For example if we want to remove PathNode from explanation, define constructor as <code>Duff.Daf(::PathNode) = ExplainMill.SkipDaf()</code></p><h2 id="Design-thoughts-on-logic-output"><a class="docs-heading-anchor" href="#Design-thoughts-on-logic-output">Design thoughts on logic output</a><a id="Design-thoughts-on-logic-output-1"></a><a class="docs-heading-anchor-permalink" href="#Design-thoughts-on-logic-output" title="Permalink"></a></h2><ul><li>We need to carry observations that will be exported downward, otherwise skipped explanation and export of arrays would not work properly. This can get into interesting situations, where </li><li>something can be present because of the upper mask but missing because of the lower mask. In this case, I will emit missing</li></ul></article><nav class="docs-footer"><a class="docs-footer-nextpage" href="references/">References »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Wednesday 3 January 2024 12:10">Wednesday 3 January 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
